//SPDX-License-Identifier: Unlicense
pragma solidity ^0.8.0;

import "@openzeppelin/contracts/token/ERC20/ERC20.sol";
import "hardhat/console.sol";

contract OptimizedWATERV2 is ERC20 {
    constructor(uint256 initialSupply) ERC20("WaterToken", "WATER") {
        _mint(msg.sender, initialSupply);
    }
}

contract OptimizedMELONV2 is ERC20 {
    constructor(uint256 initialSupply) ERC20("MelonToken", "MELON") {
        _mint(msg.sender, initialSupply);
    }
}

contract OptimizedFruitStandV2 {
    struct UserStake {
        uint256 startBlock;
        uint256 stakeAmount;
    }

    ERC20 immutable water;
    ERC20 immutable melon;
    mapping(address => UserStake) userStakes;

    mapping(uint256 => uint256) fibNumbers;

    constructor(address _water, address _melon) {
        water = ERC20(_water);
        melon = ERC20(_melon);

        fibNumbers[2] = 1;
        fibNumbers[3] = 2;
        fibNumbers[4] = 3;
        fibNumbers[5] = 5;
        fibNumbers[6] = 8;
        fibNumbers[7] = 13;
        fibNumbers[8] = 21;
        fibNumbers[9] = 34;
        fibNumbers[10] = 55;
        fibNumbers[11] = 89;
        fibNumbers[12] = 144;
        fibNumbers[13] = 233;
        fibNumbers[14] = 377;
        fibNumbers[15] = 610;
        fibNumbers[16] = 987;
        fibNumbers[17] = 1597;
        fibNumbers[18] = 2584;
        fibNumbers[19] = 4181;
        fibNumbers[20] = 6765;
        fibNumbers[21] = 10946;
        fibNumbers[22] = 17711;
        fibNumbers[23] = 28657;
        fibNumbers[24] = 46368;
        fibNumbers[25] = 75025;
        fibNumbers[26] = 121393;
        fibNumbers[27] = 196418;
        fibNumbers[28] = 317811;
        fibNumbers[29] = 514229;
        fibNumbers[30] = 832040;
        fibNumbers[31] = 1346269;
        fibNumbers[32] = 2178309;
        fibNumbers[33] = 3524578;
        fibNumbers[34] = 5702887;
        fibNumbers[35] = 9227465;
        fibNumbers[36] = 14930352;
        fibNumbers[37] = 24157817;
        fibNumbers[38] = 39088169;
        fibNumbers[39] = 63245986;
        fibNumbers[40] = 102334155;
        fibNumbers[41] = 165580141;
        fibNumbers[42] = 267914296;
        fibNumbers[43] = 433494437;
        fibNumbers[44] = 701408733;
        fibNumbers[45] = 1134903170;
        fibNumbers[46] = 1836311903;
        fibNumbers[47] = 2971215073;
        fibNumbers[48] = 4807526976;
        fibNumbers[49] = 7778742049;
        fibNumbers[50] = 12586269025;
        fibNumbers[51] = 20365011074;
        fibNumbers[52] = 32951280099;
        fibNumbers[53] = 53316291173;
        fibNumbers[54] = 86267571272;
        fibNumbers[55] = 139583862445;
        fibNumbers[56] = 225851433717;
        fibNumbers[57] = 365435296162;
        fibNumbers[58] = 591286729879;
        fibNumbers[59] = 956722026041;
        fibNumbers[60] = 1548008755920;
        fibNumbers[61] = 2504730781961;
        fibNumbers[62] = 4052739537881;
        fibNumbers[63] = 6557470319842;
        fibNumbers[64] = 10610209857723;
        fibNumbers[65] = 17167680177565;
        fibNumbers[66] = 27777890035288;
        fibNumbers[67] = 44945570212853;
        fibNumbers[68] = 72723460248141;
        fibNumbers[69] = 117669030460994;
        fibNumbers[70] = 190392490709135;
        fibNumbers[71] = 308061521170129;
        fibNumbers[72] = 498454011879264;
        fibNumbers[73] = 806515533049393;
        fibNumbers[74] = 1304969544928657;
        fibNumbers[75] = 2111485077978050;
        fibNumbers[76] = 3416454622906707;
        fibNumbers[77] = 5527939700884757;
        fibNumbers[78] = 8944394323791464;
        fibNumbers[79] = 14472334024676220;
        fibNumbers[80] = 23416728348467684;
        fibNumbers[81] = 37889062373143904;
        fibNumbers[82] = 61305790721611584;
        fibNumbers[83] = 99194853094755488;
        fibNumbers[84] = 160500643816367072;
        fibNumbers[85] = 259695496911122560;
        fibNumbers[86] = 420196140727489664;
        fibNumbers[87] = 679891637638612224;
        fibNumbers[88] = 1100087778366101888;
        fibNumbers[89] = 1779979416004713984;
        fibNumbers[90] = 2880067194370816000;
        fibNumbers[91] = 4660046610375530496;
        fibNumbers[92] = 7540113804746346496;
        fibNumbers[93] = 12200160415121876992;
        fibNumbers[94] = 19740274219868225536;
        fibNumbers[95] = 31940434634990100480;
        fibNumbers[96] = 51680708854858326016;
        fibNumbers[97] = 83621143489848426496;
        fibNumbers[98] = 135301852344706760704;
        fibNumbers[99] = 218922995834555203584;
        fibNumbers[100] = 354224848179261997056;
        fibNumbers[101] = 573147844013817200640;
        fibNumbers[102] = 927372692193079197696;
        fibNumbers[103] = 1500520536206896267264;
        fibNumbers[104] = 2427893228399975464960;
        fibNumbers[105] = 3928413764606871732224;
        fibNumbers[106] = 6356306993006847721472;
        fibNumbers[107] = 10284720757613719977984;
        fibNumbers[108] = 16641027750620567699456;
        fibNumbers[109] = 26925748508234287677440;
        fibNumbers[110] = 43566776258854857474048;
        fibNumbers[111] = 70492524767089140957184;
        fibNumbers[112] = 114059301025944006819840;
        fibNumbers[113] = 184551825793033147777024;
        fibNumbers[114] = 298611126818977154596864;
        fibNumbers[115] = 483162952612010302373888;
        fibNumbers[116] = 781774079430987490525184;
        fibNumbers[117] = 1264937032042997792899072;
        fibNumbers[118] = 2046711111473985149206528;
        fibNumbers[119] = 3311648143516982673670144;
        fibNumbers[120] = 5358359254990968359747584;
        fibNumbers[121] = 8670007398507951033417728;
        fibNumbers[122] = 14028366653498919393165312;
        fibNumbers[123] = 22698374052006868279099392;
        fibNumbers[124] = 36726740705505785524781056;
        fibNumbers[125] = 59425114757512653803880448;
        fibNumbers[126] = 96151855463018439328661504;
        fibNumbers[127] = 155576970220531084542607360;
        fibNumbers[128] = 251728825683549523871268864;
        fibNumbers[129] = 407305795904080642773614592;
        fibNumbers[130] = 659034621587630097925406720;
        fibNumbers[131] = 1066340417491710740699021312;
        fibNumbers[132] = 1725375039079340838624428032;
        fibNumbers[133] = 2791715456571051854201356288;
        fibNumbers[134] = 4517090495650392692825784320;
        fibNumbers[135] = 7308805952221445096782954496;
        fibNumbers[136] = 11825896447871837239852924928;
        fibNumbers[137] = 19134702400093282336635879424;
        fibNumbers[138] = 30960598847965121775512059904;
        fibNumbers[139] = 50095301248058406311171194880;
        fibNumbers[140] = 81055900096023528086683254784;
        fibNumbers[141] = 131151201344081925601761427456;
        fibNumbers[142] = 212207101440105453688444682240;
        fibNumbers[143] = 343358302784187344105834020864;
        fibNumbers[144] = 555565404224292762609906614272;
        fibNumbers[145] = 898923707008480106715740635136;
        fibNumbers[146] = 1454489111232773010063135604736;
        fibNumbers[147] = 2353412818241253116778876239872;
        fibNumbers[148] = 3807901929474025845367035133952;
        fibNumbers[149] = 6161314747715278680670934663168;
        fibNumbers[150] = 9969216677189304526037969797120;
        fibNumbers[151] = 16130531424904583206708904460288;
        fibNumbers[152] = 26099748102093887732746874257408;
        fibNumbers[153] = 42230279526998473191255592402944;
        fibNumbers[154] = 68330027629092365427602094030848;
        fibNumbers[155] = 110560307156090847626056941174784;
        fibNumbers[156] = 178890334785183213053659035205632;
        fibNumbers[157] = 289450641941274060679715976380416;
        fibNumbers[158] = 468340976726457273733375011586048;
        fibNumbers[159] = 757791618667731334413090987966464;
        fibNumbers[160] = 1226132595394188680204060037480448;
        fibNumbers[161] = 1983924214061920014617151025446912;
        fibNumbers[162] = 3210056809456108694821211062927360;
        fibNumbers[163] = 5193981023518028132977609784950784;
        fibNumbers[164] = 8404037832974136827798820847878144;
        fibNumbers[165] = 13598018856492164960776430632828928;
        fibNumbers[166] = 22002056689466301788575251480707072;
        fibNumbers[167] = 35600075545958466749351682113536000;
        fibNumbers[168] = 57602132235424768537926933594243072;
        fibNumbers[169] = 93202207781383226063906578853003264;
        fibNumbers[170] = 150804340016807994601833512447246336;
        fibNumbers[171] = 244006547798191220665740091300249600;
        fibNumbers[172] = 394810887814999252161061751166599168;
        fibNumbers[173] = 638817435613190509720289989885952000;
        fibNumbers[174] = 1033628323428189761881351741052551168;
        fibNumbers[175] = 1672445759041380271601641730938503168;
        fibNumbers[176] = 2706074082469570033482993471991054336;
        fibNumbers[177] = 4378519841510950009936730023576731648;
        fibNumbers[178] = 7084593923980519453123913136862134272;
        fibNumbers[179] = 11463113765491469463060643160438865920;
        fibNumbers[180] = 18547707689471988916184556297301000192;
        fibNumbers[181] = 30010821454963458379245199457739866112;
        fibNumbers[182] = 48558529144435442573063272885395652608;
        fibNumbers[183] = 78569350599398900952308472343135518720;
        fibNumbers[184] = 127127879743834343525371745228531171328;
        fibNumbers[185] = 205697230343233244477680217571666690048;
        fibNumbers[186] = 332825110087067588003051962800197861376;
        fibNumbers[187] = 538522340430300870259664043329026260992;
        fibNumbers[188] = 871347450517368382704852280214900703232;
        fibNumbers[189] = 1409869790947669101848788871715280125952;
        fibNumbers[190] = 2281217241465037484553641151930180829184;
        fibNumbers[191] = 3691087032412706888633884927302754631680;
        fibNumbers[192] = 5972304273877744675418980982890229137408;
        fibNumbers[193] = 9663391306290451564052865910192983769088;
        fibNumbers[194] = 15635695580168196239471846893083212906496;
        fibNumbers[195] = 25299086886458650221376352032534546087936;
        fibNumbers[196] = 40934782466626846460848198925617758994432;
        fibNumbers[197] = 66233869353085491846521272499635606257664;
        fibNumbers[198] = 107168651819712333471666192966736666427392;
        fibNumbers[199] = 173402521172797825318187465466372272685056;
        fibNumbers[200] = 280571172992510158789853658433108939112448;
        fibNumbers[201] = 453973694165307964765228010065414416498688;
        fibNumbers[202] = 734544867157818046183829213162256174415872;
        fibNumbers[203] = 1188518561323126010949057223227670590914560;
        fibNumbers[204] = 1923063428480943902390381525717392402939904;
        fibNumbers[205] = 3111581989804070068081943659617597356244992;
        fibNumbers[206] = 5034645418285013970472325185334989759184896;
        fibNumbers[207] = 8146227408089083419584249202262449665867776;
        fibNumbers[208] = 13180872826374098627996613672977714324176896;
        fibNumbers[209] = 21327100234463182047580862875240163990044672;
        fibNumbers[210] = 34507973060837280675577476548217878314221568;
        fibNumbers[211] = 55835073295300462723158339423458042304266240;
        fibNumbers[212] = 90343046356137748350495973113197020214984704;
        fibNumbers[213] = 146178119651438211073654312536655062519250944;
        fibNumbers[214] = 236521166007575939617109657083767684348248064;
        fibNumbers[215] = 382699285659014170497804598186507145253486592;
        fibNumbers[216] = 619220451666590110114914255270274829601734656;
        fibNumbers[217] = 1001919737325604201384556339192444381311270912;
        fibNumbers[218] = 1621140188992194232271308080198381617369055232;
        fibNumbers[219] = 2623059926317798433655864419390825998680326144;
        fibNumbers[220] = 4244200115309992665927172499589207616049381376;
        fibNumbers[221] = 6867260041627790465757736804865332866378104832;
        fibNumbers[222] = 11111460156937783765510209418569241230779088896;
        fibNumbers[223] = 17978720198565574231267946223434574097157193728;
        fibNumbers[224] = 29090180355503355461476955185545012334529871872;
        fibNumbers[225] = 47068900554068929692744901408979586431687065600;
        fibNumbers[226] = 76159080909572285154221856594524598766216937472;
        fibNumbers[227] = 123227981463641224988171559829339397171529646080;
        fibNumbers[228] = 199387062373213510142393416423863995937746583552;
        fibNumbers[229] = 322615043836854735130564976253203393109276229632;
        fibNumbers[230] = 522002106210068245272958392677067389047022813184;
        fibNumbers[231] = 844617150046922939838704161626929934261796470784;
        fibNumbers[232] = 1366619256256991103982024139697315627519814139904;
        fibNumbers[233] = 2211236406303914206080005130537608953359620898816;
        fibNumbers[234] = 3577855662560905310062029270234924580879435038720;
        fibNumbers[235] = 5789092068864819516142034400772533534239055937536;
        fibNumbers[236] = 9366947731425724177166956354154004548806449823744;
        fibNumbers[237] = 15156039800290543693308990754926538083045505761280;
        fibNumbers[238] = 24522987531716267870475947109080542631851955585024;
        fibNumbers[239] = 39679027332006811563784937864007080714897461346304;
        fibNumbers[240] = 64202014863723079434260884973087623346749416931328;
        fibNumbers[241] = 103881042195729885805748964302267075531150549057536;
        fibNumbers[242] = 168083057059452965240009849275354698877899965988864;
        fibNumbers[243] = 271964099255182871814946247716932288531035831926784;
        fibNumbers[244] = 440047156314635816285768662852976473286950481035264;
        fibNumbers[245] = 712011255569818688100714910569908761817986312962048;
        fibNumbers[246] = 1152058411884454421309733836865643178616995526475776;
        fibNumbers[247] = 1864069667454273109410448747435551940434981839437824;
        fibNumbers[248] = 3016128079338727198413183638072226893100212295827456;
        fibNumbers[249] = 4880197746793000307823632385507778833535194135265280;
        fibNumbers[250] = 7896325826131727506236816023580005726635406431092736;
        fibNumbers[251] = 12776523572924727814060448409087784560170600566358016;
        fibNumbers[252] = 20672849399056455320297264432667790286806006997450752;
        fibNumbers[253] = 33449372971981180475901721271923829039362487003119616;
        fibNumbers[254] = 54122222371037638454654977274423365133782614561259520;
        fibNumbers[255] = 87571595343018818930556698546347194173145101564379136;
        fibNumbers[
            256
        ] = 141693817714056468019035642100097542537384198368395264;
        fibNumbers[
            257
        ] = 229265413057075276315768374367117753480072817690017792;
        fibNumbers[
            258
        ] = 370959230771131744334804016467215296017457016058413056;
        fibNumbers[
            259
        ] = 600224643828207063185868255951640982419355762719457280;
        fibNumbers[
            260
        ] = 971183874599338764985376407301548345514986849806843904;
        fibNumbers[
            261
        ] = 1571408518427545998312428123722421059621646328410406912;
        fibNumbers[
            262
        ] = 2542592393026884763297804531023969405136633178217250816;
        fibNumbers[
            263
        ] = 4114000911454431101892599575684853928132886938395869184;
        fibNumbers[
            264
        ] = 6656593304481315524908037185770359869894912684844908544;
        fibNumbers[
            265
        ] = 10770594215935746626800636761455213798027799623240777728;
        fibNumbers[
            266
        ] = 17427187520417062151708673947225573667922712308085686272;
        fibNumbers[
            267
        ] = 28197781736352807417379843024926933612452082204253618176;
        fibNumbers[
            268
        ] = 45624969256769869569088516972152507280374794512339304448;
        fibNumbers[
            269
        ] = 73822750993122682430986230732094856306820595624884305920;
        fibNumbers[
            270
        ] = 119447720249892546555556876969231948173201671228932227072;
        fibNumbers[
            271
        ] = 193270471243015228986543107701326804480022266853816532992;
        fibNumbers[
            272
        ] = 312718191492907775542099984670558752653223938082748760064;
        fibNumbers[
            273
        ] = 505988662735923004528643092371885557133246204936565293056;
        fibNumbers[
            274
        ] = 818706854228830823626886042922567633098419894285645119488;
        fibNumbers[
            275
        ] = 1324695516964753828155529135294453190231666099222210412544;
        fibNumbers[
            276
        ] = 2143402371193584651782415178217020823330085993507855532032;
        fibNumbers[
            277
        ] = 3468097888158338479937944313511474013561752092730065944576;
        fibNumbers[
            278
        ] = 5611500259351922783271215764687508250396240076107272945664;
        fibNumbers[
            279
        ] = 9079598147510260566310872624117009090966796148576041828352;
        fibNumbers[
            280
        ] = 14691098406862181955785513480640570995380644184160720650240;
        fibNumbers[
            281
        ] = 23770696554372442522096386104757580086347440332736762478592;
        fibNumbers[
            282
        ] = 38461794961234621690288749769070258389763300435852294881280;
        fibNumbers[
            283
        ] = 62232491515607066999978285690155731168075524849634245607424;
        fibNumbers[
            284
        ] = 100694286476841677539894436193914418789979688961305787498496;
        fibNumbers[
            285
        ] = 162926777992448733389500122618758579190196077486759280115712;
        fibNumbers[
            286
        ] = 263621064469290410929394558812672997980175766448065067614208;
        fibNumbers[
            287
        ] = 426547842461739099717404284370185294098935298638101335769088;
        fibNumbers[
            288
        ] = 690168906931029510646798843182858292079111065086166403383296;
        fibNumbers[
            289
        ] = 1116716749392768610364203127553043586178046363724267739152384;
        fibNumbers[
            290
        ] = 1806885656323798121011001970735901878257157428810434142535680;
        fibNumbers[
            291
        ] = 2923602405716566909781166686533930596720949973721593929531392;
        fibNumbers[
            292
        ] = 4730488062040365387604091833759802739549599764905812167753728;
        fibNumbers[
            293
        ] = 7654090467756932297385258520293733336270549738627406097285120;
        fibNumbers[
            294
        ] = 12384578529797297684989350354053536075820149503533218265038848;
        fibNumbers[
            295
        ] = 20038668997554229982374608874347269412090699242160624362323968;
        fibNumbers[
            296
        ] = 32423247527351529094611651934360686546196818195188979010109440;
        fibNumbers[
            297
        ] = 52461916524905759076986260808707955958287517437349603372433408;
        fibNumbers[
            298
        ] = 84885164052257288171597912743068642504484335632538582382542848;
        fibNumbers[
            299
        ] = 137347080577163047248584173551776598462771853069888185754976256;
        fibNumbers[
            300
        ] = 222232244629420346838163627942524289433543944298387859199492096;
    }

    function stake(uint256 _amount) external {
        if (userStakes[msg.sender].startBlock != 0) {
            // Pay out current stake
            payout(msg.sender, userStakes[msg.sender]);
        }

        UserStake memory newStake = UserStake({
            startBlock: block.number,
            stakeAmount: _amount
        });

        userStakes[msg.sender] = newStake;
    }

    function unstake() external {
        require(userStakes[msg.sender].startBlock != 0, "User have not staked");
        payout(msg.sender, userStakes[msg.sender]);
        userStakes[msg.sender] = UserStake({startBlock: 0, stakeAmount: 0});
    }

    function payout(address user, UserStake memory stake)
        internal
        returns (uint8 errCode)
    {
        uint256 blockDelta = block.number - stake.startBlock;
        if (blockDelta > 300) {
            blockDelta = 300;
        }

        uint256 multiplier = 0;
        // multiplier = fib(blockDelta);
        if (fibNumbers[blockDelta] > 0) {
            multiplier = fibNumbers[blockDelta];
        } else {
            multiplier = fib(blockDelta);
        }
        uint256 rewardAmount = multiplier * stake.stakeAmount;
        melon.transfer(user, rewardAmount);
        return 0;
    }

    function fib(uint256 n) private pure returns (uint256 a) {
        if (n == 0) {
            return 0;
        }
        uint256 h = n / 2;
        uint256 mask = 1;
        // find highest set bit in n
        while (mask <= h) {
            mask <<= 1;
        }
        mask >>= 1;
        a = 1;
        uint256 b = 1;
        uint256 c;
        while (mask > 0) {
            c = a * a + b * b;
            if (n & mask > 0) {
                b = b * (b + 2 * a);
                a = c;
            } else {
                a = a * (2 * b - a);
                b = c;
            }
            mask >>= 1;
        }
        return a;
    }
}
